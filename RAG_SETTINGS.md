# RAGシステム設定まとめ

このドキュメントは、現在のRAGシステムの全設定をまとめたものです。

---

## 📦 1. チャンク設定

### チャンクサイズ

- **サイズ**: 600文字
- **オーバーラップ**: 150文字
- **実装箇所**:
  - `src/app/api/documents/route.ts` (新規登録時)
  - `src/app/api/documents/[id]/route.ts` (更新時)

### チャンク分割ロジック

```typescript
chunkText(content, 600, 150);
```

- 600文字ごとに分割
- 各チャンク間で150文字のオーバーラップを設定
- 文脈の連続性を保つため

---

## 🔍 2. 検索設定

### 検索で取得するチャンク数

- **取得数**: 上位3チャンク
- **実装箇所**: `src/app/rag/page.tsx` (line 626)

```typescript
body: JSON.stringify({ query: userMessage, limit: 3 });
```

### 検索アルゴリズム

- **埋め込みモデル**: `text-embedding-3-small`
- **類似度計算**: コサイン類似度
- **ソート**: 類似度の降順
- **実装箇所**: `src/app/api/search/route.ts`

### 検索結果の形式

```typescript
{
  chunks: [
    {
      content: string, // チャンクの内容
      documentTitle: string, // ドキュメントのタイトル
      similarity: number, // 類似度スコア
      documentId: number,
      chunkIndex: number,
    },
  ];
}
```

---

## 💬 3. プロンプト設定

### 通常モード（登録情報優先 + 一般知識フォールバック）

```text
あなたは記事内容をベースにして質問に答えるヘルパーです。

【最重要ルール】
・要約ではなく、質問への回答を書く（質問を冒頭で受けている形にする）
・箇条書きではなく、自然な文章中心で回答する
・文脈の自然さを優先する
・コンテキストの語り口を軽く反映してよい（記事の雰囲気・温度感を取り入れる）
・要点だけでなく、理由や背景も短く添える
・コンテキスト以外の情報を加えない（一般知識を混ぜない）
・要約っぽさを弱め、自然な流れを意識する（導入→説明→まとめの構成）

【回答の書き方】
・回答の冒頭で質問を受けている形にする（例：「note初心者がジャンルを決めるときは...」）
・「理由 → 結論」のストーリーを短くでも入れると読みやすくなる
・箇条書き型の情報列挙から脱却し、文章として自然に流れるようにする
・渡されたコンテキストの範囲だけで回答する
・記事の結論を中心に、質問に直接答える
・関係ない情報は省く
・本文の単純な要約ではなく「質問への最適回答」にする
・要約しすぎず、質問の意図に合わせて必要な情報を選んで回答する

【回答の構成】
・導入：質問への直接的な回答を冒頭で示す
・説明：理由や背景を含めて自然に説明する
・まとめ：必要に応じて簡潔にまとめる
・結論が唐突に箇条書きで並ばないように調整する

【回答方針】
1. 提供されたコンテキスト情報（登録された情報）がある場合は、それを最優先で参照して回答してください。
2. コンテキスト情報がない場合、またはコンテキスト情報だけでは回答できない場合は、一般的な知識に基づいて回答してください。
3. 登録された情報を参照して回答した場合は、回答の最後に「参照したドキュメント: [タイトル1], [タイトル2], ...」という形式で参照したドキュメントのタイトルを必ず明記してください。
4. 一般的な知識のみで回答した場合は、参照したドキュメントの記載は不要です。

質問に最適化された、自然で人間味のある、人に読まれる文章として回答を提供してください。
```

### 登録情報のみモード（一般知識禁止）

```text
あなたは記事内容をベースにして質問に答えるヘルパーです。登録されたドキュメントのみを参照してください。

【最重要ルール】
・要約ではなく、質問への回答を書く（質問を冒頭で受けている形にする）
・箇条書きではなく、自然な文章中心で回答する
・文脈の自然さを優先する
・コンテキストの語り口を軽く反映してよい（記事の雰囲気・温度感を取り入れる）
・要点だけでなく、理由や背景も短く添える
・コンテキスト以外の情報を絶対に加えない（一般知識を一切混ぜない）
・要約っぽさを弱め、自然な流れを意識する（導入→説明→まとめの構成）

【回答の書き方】
・回答の冒頭で質問を受けている形にする（例：「note初心者がジャンルを決めるときは...」）
・「理由 → 結論」のストーリーを短くでも入れると読みやすくなる
・箇条書き型の情報列挙から脱却し、文章として自然に流れるようにする
・渡されたコンテキストの範囲だけで回答する
・記事の結論を中心に、質問に直接答える
・関係ない情報は省く
・本文の単純な要約ではなく「質問への最適回答」にする
・要約しすぎず、質問の意図に合わせて必要な情報を選んで回答する

【回答の構成】
・導入：質問への直接的な回答を冒頭で示す
・説明：理由や背景を含めて自然に説明する
・まとめ：必要に応じて簡潔にまとめる
・結論が唐突に箇条書きで並ばないように調整する

【回答方針】
1. 提供されたコンテキスト情報（登録された情報）のみを参照して回答してください。
2. コンテキスト情報がない場合、またはコンテキスト情報だけでは回答できない場合は、「登録された情報からは回答できませんでした」と明確に伝えてください。
3. 登録された情報を参照して回答した場合は、回答の最後に「参照したドキュメント: [タイトル1], [タイトル2], ...」という形式で参照したドキュメントのタイトルを必ず明記してください。

質問に最適化された、自然で人間味のある、人に読まれる文章として回答を提供してください。
```

**主な違い**:

- 通常モード: コンテキストがない場合、一般知識で回答可能
- 登録情報のみモード: コンテキストがない場合、「回答できませんでした」と返す

---

## 📝 4. コンテキストの渡し方

### コンテキストフォーマット

```typescript
contextText = `以下の登録された情報を参照して、質問に直接答えてください:

[ドキュメントタイトル1]
チャンク内容1

[ドキュメントタイトル2]
チャンク内容2

[ドキュメントタイトル3]
チャンク内容3

ユーザーの質問: ${message}`;
```

### 実装詳細

- 各チャンクにドキュメントタイトルを付与
- 複数のチャンクを`\n\n`で区切って結合
- ユーザーの質問を最後に追加

**実装箇所**: `src/app/api/threads/[threadId]/messages/route.ts` (line 174-195)

---

## 🎯 5. 参照ドキュメントタイトルの自動追加

### 機能

回答の最後に、参照したドキュメントのタイトルを自動的に追加します。

### 実装ロジック

```typescript
if (referencedTitles.length > 0) {
  const hasTitleReference = referencedTitles.some((title) => assistantContent.includes(title));
  if (!hasTitleReference && !assistantContent.includes('参照したドキュメント')) {
    assistantContent += `\n\n参照したドキュメント: ${referencedTitles.join(', ')}`;
  }
}
```

**条件**:

- 参照したタイトルが存在する場合
- 回答内にタイトルが含まれていない場合
- 「参照したドキュメント」という文字列が含まれていない場合

**実装箇所**: `src/app/api/threads/[threadId]/messages/route.ts` (line 295-301)

---

## 🤖 6. OpenAI設定

### 使用モデル

- **埋め込みモデル**: `text-embedding-3-small`
- **アシスタントモデル**: `gpt-4-turbo-preview`
  (環境変数`OPENAI_ASSISTANT_ID`が設定されている場合はそのアシスタントを使用)

### アシスタント実行方法

- `run`作成時に`instructions`を動的に渡す
- これにより、モード（通常/登録情報のみ）に応じてプロンプトを変更可能

**実装箇所**: `src/app/api/threads/[threadId]/messages/route.ts` (line 265-269)

---

## 📊 7. 設定のまとめ表

| 項目               | 設定値                 | 備考                  |
| ------------------ | ---------------------- | --------------------- |
| チャンクサイズ     | 600文字                | 400-700の推奨範囲内   |
| オーバーラップ     | 150文字                | 文脈の連続性を保つ    |
| 取得チャンク数     | 3チャンク              | 上位3件を取得         |
| 埋め込みモデル     | text-embedding-3-small | OpenAI Embeddings API |
| アシスタントモデル | gpt-4-turbo-preview    | OpenAI Assistants API |
| 類似度計算         | コサイン類似度         | ベクトル間の類似度    |

---

## 🔄 8. 処理フロー

1. **ドキュメント登録時**

   - テキストを600文字、150文字オーバーラップでチャンク分割
   - 各チャンクの埋め込みベクトルを生成
   - データベースに保存

2. **質問時**
   - 質問文の埋め込みベクトルを生成
   - 全チャンクとのコサイン類似度を計算
   - 上位3チャンクを取得
   - チャンクとタイトル情報をコンテキストとしてフォーマット
   - OpenAI Assistants APIに送信
   - 回答を取得し、参照ドキュメントタイトルを自動追加

---

## 📁 9. 関連ファイル

- `src/lib/openai.ts` - チャンク分割、埋め込み生成、類似度計算
- `src/app/api/documents/route.ts` - ドキュメント登録時のチャンク分割
- `src/app/api/documents/[id]/route.ts` - ドキュメント更新時のチャンク再分割
- `src/app/api/search/route.ts` - ベクトル検索
- `src/app/api/threads/[threadId]/messages/route.ts` - メッセージ送信、プロンプト構築
- `src/app/rag/page.tsx` - フロントエンド（検索実行、メッセージ送信）

---

## 💡 10. 改善ポイント（現在実装済み）

✅ チャンクサイズを400-700字の範囲に最適化（600字）  
✅ 上位2-3チャンクを渡す（3チャンク）  
✅ 質問への回答を最優先にする指示  
✅ 自然な文章中心で回答する指示  
✅ コンテキストの語り口を反映する指示  
✅ 導入→説明→まとめの構成を意識する指示  
✅ 参照ドキュメントタイトルの自動追加  
✅ 登録情報のみモードの実装

---

以上が現在のRAGシステムの全設定です。
