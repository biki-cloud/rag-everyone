# RAGシステム 初心者向け解説

このドキュメントは、このアプリケーションを初めて使う方や、開発を始める初心者の方向けに、わかりやすく解説したものです。

---

## 📖 目次

1. [このアプリとは？](#このアプリとは)
2. [RAG（レトリバル拡張生成）とは？](#ragレトリバル拡張生成とは)
3. [主な機能](#主な機能)
4. [技術スタック](#技術スタック)
5. [セットアップ手順](#セットアップ手順)
6. [使い方](#使い方)
7. [アーキテクチャの説明](#アーキテクチャの説明)
8. [よくある質問](#よくある質問)

---

## このアプリとは？

このアプリケーションは、**RAG（Retrieval-Augmented
Generation）システム**を実装したWebアプリケーションです。

簡単に言うと、**自分で登録した情報を参照しながら、AIが質問に答えてくれるシステム**です。

### 具体例

例えば、あなたが会社のマニュアルや、自分のメモ、記事などを登録しておくと：

- 「このプロジェクトの進め方は？」と質問
- システムが登録された情報から関連する部分を自動で検索
- その情報を元にAIが回答を生成

という流れで、あなたの情報に基づいた正確な回答を得られます。

---

## RAG（レトリバル拡張生成）とは？

RAGは、AIに「最新の情報」や「特定の情報」を参照させて回答させる技術です。

### なぜRAGが必要？

通常のChatGPTなどのAIは、学習した時点までの情報しか知りません。また、あなたの会社の内部情報や、個人的なメモなどは知りません。

RAGを使うと：

- ✅ 最新の情報を参照できる
- ✅ あなた専用の情報を参照できる
- ✅ より正確で、文脈に合った回答が得られる

### RAGの仕組み（簡単に）

```
1. 情報を登録
   ↓
2. 情報を小さな塊（チャンク）に分割
   ↓
3. 各チャンクを「ベクトル」という数値の配列に変換（埋め込み）
   ↓
4. 質問が来たら、質問もベクトルに変換
   ↓
5. 質問のベクトルと、登録情報のベクトルを比較して、似ているものを検索
   ↓
6. 見つかった情報をAIに渡して、回答を生成
```

---

## 主な機能

このアプリには、以下の3つの主要機能があります。

### 1. 📄 ドキュメント登録機能

- タイトルと内容を入力して、AIに参照させたい情報を登録できます
- 登録された情報は自動的に小さな塊（チャンク）に分割され、検索しやすい形で保存されます

**使用例：**

- 会社のマニュアル
- プロジェクトのドキュメント
- 個人的なメモや記事
- FAQ（よくある質問）

### 2. 💬 チャット機能

- LINE風の会話インターフェースで、AIと対話できます
- 質問すると、登録されたドキュメントから関連情報を自動検索し、それを元に回答します
- 会話の履歴が保存され、過去の会話を振り返ることができます

**特徴：**

- 複数の会話（スレッド）を管理できる
- 各会話にタイトルを付けることができる
- マークダウン形式で回答が表示される

### 3. 🔍 RAG検索機能

- 質問に基づいて、登録されたドキュメントから関連する情報を検索します
- ベクトル検索という技術を使って、意味的に似ている情報を見つけます

**検索の流れ：**

1. 質問文をベクトルに変換
2. 登録されたすべてのチャンクと比較
3. 最も似ている上位3つのチャンクを取得
4. それらをAIに渡して回答を生成

---

## 技術スタック

このアプリで使用されている主要な技術を、初心者向けに説明します。

### フロントエンド（見た目・操作部分）

- **Next.js 14**: ReactベースのWebアプリケーションフレームワーク
  - ページの表示や、ユーザーとのやり取りを担当
- **React**: UIを構築するためのJavaScriptライブラリ
- **Tailwind CSS**: スタイリング（見た目）を簡単に書けるCSSフレームワーク

### バックエンド（サーバー側・処理部分）

- **Next.js API Routes**: サーバー側の処理を書くための機能
  - ドキュメントの登録、検索、チャットなどの処理を担当

### データベース

- **Cloudflare D1**: SQLiteベースのデータベース
  - ドキュメント、チャンク、会話履歴などを保存
- **Drizzle ORM**: データベースを操作するためのツール
  - SQLを直接書かずに、TypeScriptでデータベースを操作できる

### 認証

- **Supabase Auth**: ユーザー認証（ログイン機能）を提供
  - Googleアカウントなどでログインできる

### AI関連

- **OpenAI API**:
  - **Embeddings API**: テキストをベクトルに変換（`text-embedding-3-small`）
  - **Chat Completions API**: チャット機能を実現
    - デフォルトモデル: `gpt-5`（環境変数 `OPENAI_MODEL` で変更可能）
    - サポートされているモデル: `gpt-5`, `gpt-4o`, `gpt-4o-mini`, `gpt-4-turbo-preview`, `gpt-4`

### その他

- **TypeScript**: JavaScriptに型を追加した言語（エラーを防ぎやすい）
- **pnpm**: パッケージマネージャー（ライブラリを管理するツール）

---

## セットアップ手順

このアプリを自分の環境で動かすための手順です。

### 前提条件

以下のツールがインストールされている必要があります：

- **Node.js** (v20.11.0以上)
- **pnpm** (v9.15.1以上)

インストール方法：

```bash
# Node.jsのインストール（Homebrewを使用する場合）
brew install node

# pnpmのインストール
npm install -g pnpm
```

### 1. リポジトリのクローン

```bash
git clone <リポジトリのURL>
cd rag-everyone
```

### 2. 依存関係のインストール

```bash
pnpm install
```

### 3. 環境変数の設定

`.env.development` ファイルを作成し、以下の環境変数を設定します：

```env
# Supabaseの設定（認証用）
NEXT_PUBLIC_SUPABASE_URL="https://your-project.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"

# OpenAI APIキー（AI機能用）
OPENAI_API_KEY="sk-..."

# Cloudflareの設定（本番環境用、開発時は空でOK）
CLOUDFLARE_ACCOUNT_ID=""
CLOUDFLARE_USER_API_TOKEN=""
DB_REMOTE_DATABASE_ID=""
```

**環境変数の取得方法：**

- **Supabase**: [Supabase](https://supabase.com) でプロジェクトを作成し、設定画面から取得
- **OpenAI**: [OpenAI Platform](https://platform.openai.com) でAPIキーを作成

### 4. データベースのセットアップ

```bash
# マイグレーションファイルの生成
pnpm db:generate

# 開発環境のデータベースにマイグレーションを適用
pnpm db:migrate:dev
```

### 5. アプリケーションの起動

```bash
pnpm dev
```

ブラウザで `http://localhost:3000` にアクセスすると、アプリが表示されます。

### 6. ログイン

初回アクセス時は、認証画面にリダイレクトされます。Supabaseで設定した認証方法（Googleなど）でログインしてください。

---

## 使い方

### 基本的な使い方の流れ

1. **ログイン**

   - ブラウザで `http://localhost:3000` にアクセス
   - 認証画面でログイン

2. **RAGシステムにアクセス**

   - ホーム画面から「RAGシステム」ボタンをクリック
   - `/rag` ページに移動

3. **ドキュメントを登録**

   - 「ドキュメント」タブを開く
   - 「新しいドキュメント」ボタンをクリック
   - タイトルと内容を入力して保存
   - 自動的にチャンクに分割され、ベクトル化されます

4. **チャットで質問**
   - 「チャット」タブを開く
   - 「新しい会話」ボタンをクリック
   - 質問を入力して送信
   - 登録されたドキュメントから関連情報を検索し、AIが回答します

### 詳細な使い方

#### ドキュメント登録

1. 「ドキュメント」タブを開く
2. 「新しいドキュメント」ボタンをクリック
3. モーダルが開くので、以下を入力：
   - **タイトル**: ドキュメントのタイトル（例：「プロジェクトマニュアル」）
   - **内容**: ドキュメントの本文（長文でもOK）
4. 「保存」ボタンをクリック

**注意点：**

- 長い文章でも自動的に適切なサイズに分割されます
- 登録後、少し時間がかかることがあります（ベクトル化の処理のため）

#### チャット機能

1. 「チャット」タブを開く
2. 「新しい会話」ボタンをクリック
3. 会話が開始されます
4. 下部の入力欄に質問を入力して送信

**機能：**

- 会話の履歴が保存されます
- 複数の会話を並行して管理できます
- 各会話にタイトルを付けることができます（最初の質問から自動生成される場合もあります）

#### モードの切り替え

チャット画面で、以下の2つのモードを切り替えられます：

- **通常モード**: 登録情報を優先し、見つからない場合は一般知識で回答
- **登録情報のみモード**: 登録された情報のみを参照し、見つからない場合は「回答できませんでした」と返す

---

## アーキテクチャの説明

このアプリがどのように動作しているかを、初心者向けに説明します。

### 全体の構造

```
┌─────────────────┐
│   ブラウザ      │  ← ユーザーが操作する画面
│  (Next.js UI)   │
└────────┬────────┘
         │
         │ HTTPリクエスト
         ↓
┌─────────────────┐
│  Next.js API    │  ← サーバー側の処理
│    Routes       │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ↓         ↓
┌────────┐ ┌──────────┐
│  D1 DB │ │ OpenAI   │  ← データベースとAI
│        │ │   API    │
└────────┘ └──────────┘
```

### データの流れ

#### 1. ドキュメント登録の流れ

```
ユーザーがドキュメントを入力
    ↓
Next.js API Routes (/api/documents)
    ↓
テキストを600文字のチャンクに分割
    ↓
各チャンクをOpenAI Embeddings APIでベクトル化
    ↓
D1データベースに保存
  - documents テーブル: ドキュメント情報
  - document_chunks テーブル: チャンクとベクトル
```

#### 2. 質問・回答の流れ

```
ユーザーが質問を入力
    ↓
Next.js API Routes (/api/threads/[threadId]/messages)
    ↓
1. 質問文をOpenAI Embeddings APIでベクトル化
    ↓
2. /api/search でベクトル検索
   - 全チャンクとコサイン類似度を計算
   - 上位3チャンクを取得
    ↓
3. 取得したチャンクをコンテキストとして整形
    ↓
4. OpenAI Chat Completions APIに送信
   - システムプロンプト + コンテキスト + 質問
    ↓
5. AIが回答を生成
    ↓
6. 回答をデータベースに保存（messages テーブル）
    ↓
7. ブラウザに返す
```

### データベースの構造

```
documents (ドキュメント)
  ├─ id
  ├─ title
  ├─ content
  ├─ userId
  └─ createdAt

document_chunks (チャンク)
  ├─ id
  ├─ documentId → documents.id
  ├─ content (チャンクの内容)
  ├─ embedding (ベクトル、JSON形式)
  ├─ chunkIndex
  └─ createdAt

threads (会話)
  ├─ id
  ├─ threadId (OpenAIのThread ID)
  ├─ userId
  ├─ title
  └─ createdAt

messages (メッセージ)
  ├─ id
  ├─ threadId → threads.id
  ├─ role ('user' or 'assistant')
  ├─ content
  ├─ messageId (OpenAIのMessage ID)
  └─ createdAt
```

### 重要な概念

#### チャンク（Chunk）

長い文章を、検索しやすい小さな塊に分割したもの。

- **サイズ**: 600文字
- **オーバーラップ**: 150文字（前のチャンクと次のチャンクで150文字重複）
- **理由**: 文脈の連続性を保つため

#### ベクトル（Embedding）

テキストを数値の配列に変換したもの。意味的に似ているテキストは、似たベクトルになります。

- **モデル**: `text-embedding-3-small`
- **用途**: 意味検索（キーワードではなく、意味で検索）

#### コサイン類似度

2つのベクトルがどれだけ似ているかを測る指標（0〜1の値）。

- **1に近い**: 非常に似ている
- **0に近い**: 似ていない

---

## よくある質問

### Q1. ドキュメントを登録したのに、検索で見つからない

**A:** 以下の点を確認してください：

1. ドキュメントが正しく登録されているか（「ドキュメント」タブで確認）
2. 質問の内容が、ドキュメントの内容と意味的に関連しているか
3. 少し時間をおいてから再度試す（ベクトル化の処理に時間がかかることがある）

### Q2. 回答が不正確だ

**A:** 以下の対策を試してください：

1. ドキュメントの内容をより詳しく、正確に登録する
2. 「登録情報のみモード」に切り替えて、一般知識が混ざらないようにする
3. 質問をより具体的にする

### Q3. エラーが発生する

**A:** よくある原因と対処法：

- **認証エラー**: ログインし直す
- **APIキーエラー**: `.env.development` の `OPENAI_API_KEY` が正しく設定されているか確認
- **データベースエラー**: `pnpm db:migrate:dev` を再実行

### Q4. チャンクサイズを変更したい

**A:** `src/app/api/documents/route.ts` と `src/app/api/documents/[id]/route.ts`
の以下の部分を変更：

```typescript
chunkText(content, 600, 150);
// 第2引数: チャンクサイズ
// 第3引数: オーバーラップ
```

### Q5. 検索で取得するチャンク数を変更したい

**A:** `src/app/rag/page.tsx` の以下の部分を変更：

```typescript
body: JSON.stringify({ query: userMessage, limit: 3 });
// limit の値を変更
```

### Q6. プロンプトをカスタマイズしたい

**A:** `src/app/api/threads/[threadId]/messages/route.ts` の `systemPrompt` 変数を変更してください。

詳細は `RAG_SETTINGS.md` を参照してください。

---

## まとめ

このアプリケーションは、RAG技術を使って、あなた専用の情報を参照しながらAIが回答してくれるシステムです。

主な特徴：

- ✅ ドキュメントを登録して、AIに参照させられる
- ✅ 意味検索で、関連情報を自動的に見つけられる
- ✅ LINE風の会話インターフェースで使いやすい
- ✅ 会話履歴が保存される

技術的には：

- Next.js + Cloudflare D1 + OpenAI API で構成
- ベクトル検索で意味的に似ている情報を検索
- チャンク分割で長文も効率的に処理

---

## 参考資料

- [README.md](./README.md) - 基本的なセットアップ手順
- [RAG_SETTINGS.md](./RAG_SETTINGS.md) - RAGシステムの詳細な設定
- [Next.js公式ドキュメント](https://nextjs.org/docs)
- [OpenAI APIドキュメント](https://platform.openai.com/docs)
- [Supabase公式ドキュメント](https://supabase.com/docs)

---

**質問や問題があれば、GitHubのIssuesで報告してください！**
